"use client"

import React, { useEffect } from "react"
import dynamic from "next/dynamic"
import { useTheme } from "next-themes"
import { useCMS } from "@/lib/store"
import { Shield } from "lucide-react"
import { subscribePublished } from "@/lib/realtime"
import { SiteHeader } from "@/components/layout/site-header"
import { SiteFooter } from "@/components/layout/site-footer"
import { StructuredData } from "@/components/seo/structured-data"
import { ThemeProvider } from "@/components/theme-provider"
import { Toaster } from "@/components/ui/toaster"
// Lazy-loaded, non-critical components to reduce initial bundle size
const ChatbotWidget = dynamic(
  () => import("@/components/chatbot/chatbot-widget").then(m => m.ChatbotWidget),
  { ssr: false, loading: () => null }
)
const PerfHints = dynamic(
  () => import("@/components/perf/perf-hints").then(m => m.PerfHints),
  { ssr: false, loading: () => null }
)
const ReviewsSection = dynamic(
  () => import("@/components/reviews/reviews-section").then(m => m.ReviewsSection),
  { ssr: false, loading: () => <div className="py-8 opacity-50" /> }
)
const BlocksRenderer = dynamic(
  () => import("@/components/blocks/blocks-renderer").then(m => m.BlocksRenderer),
  { ssr: false, loading: () => <div className="py-8" /> }
)

// localStorage hook (client-safe) - commented out as unused
// function useLocalStorage<T>(key: string, initialValue: T) {
//   const [value, setValue] = React.useState<T>(initialValue)

//   useEffect(() => {
//     try {
//       const raw = typeof window !== "undefined" ? window.localStorage.getItem(key) : null
//       if (raw != null) setValue(JSON.parse(raw))
//     } catch {
//       // ignore
//     }
//     // eslint-disable-next-line react-hooks/exhaustive-deps
//   }, [])

//   useEffect(() => {
//     try {
//       if (typeof window !== "undefined") {
//         window.localStorage.setItem(key, JSON.stringify(value))
//       }
//     } catch {
//       // ignore
//     }
//   }, [key, value])

//   return [value, setValue] as const
// }

// Data
const siteData: Record<string, unknown> = {
  ar: {
    site: {
      name: "KYCtrust",
      description: "ุฎุฏูุฉ ูุชุฎุตุตุฉ ูู ุงูุญุณุงุจุงุช ุงูุจูููุฉ ุงูุฅููุชุฑูููุฉ ูุงูุฎุฏูุงุช ุงููุงููุฉ ุงูุขููุฉ",
      phone: "+20-106-245-3344",
      tagline: "ุดุฑููู ุงูููุซูู ูู ุงูุนุงูู ุงูุฑููู",
    },
    hero: {
      title: "KYCtrust",
      subtitle: "ููุตุฉ ูุชูุงููุฉ ููุฎุฏูุงุช ุงููุงููุฉ ุงูุฑูููุฉ",
      description: "ุงุญุตู ุนูู ุฃูุถู ุงูุญุณุงุจุงุช ุงูุจูููุฉ ุงูุฅููุชุฑูููุฉ ูุงููุญุงูุธ ุงูุฑูููุฉ ุจุฃูุงู ูุณุฑุนุฉ ูุง ูุซูู ููุง",
      cta: "ุงุจุฏุฃ ุฑุญูุชู ุงููุงููุฉ",
      secondary: "ุชุตูุญ ุฎุฏูุงุชูุง",
      stats: [
        { number: "1000+", label: "ุนููู ุฑุงุถู" },
        { number: "24/7", label: "ุฏุนู ููู" },
        { number: "99.9%", label: "ูุนุฏู ุงููุฌุงุญ" },
        { number: "15+", label: "ุฎุฏูุฉ ูุชุงุญุฉ" },
      ],
    },
    services: [
      {
        name: "Payoneer",
        price: "$30",
        category: "ุญุณุงุจุงุช ุจูููุฉ",
        icon: "๐ณ",
        popular: true,
        active: true,
        sort: 1,
        description: "ุญุณุงุจ ุจููู ุนุงููู ููุซูู",
      },
      {
        name: "Wise",
        price: "$30",
        category: "ุญุณุงุจุงุช ุจูููุฉ",
        icon: "๐ฆ",
        popular: true,
        active: true,
        sort: 2,
        description: "ุชุญูููุงุช ุฏูููุฉ ุจุฃูู ุฑุณูู",
      },
      {
        name: "Skrill",
        price: "$20",
        category: "ูุญุงูุธ ุฅููุชุฑูููุฉ",
        icon: "๐ฐ",
        active: true,
        sort: 3,
        description: "ูุญูุธุฉ ุฅููุชุฑูููุฉ ุขููุฉ ูุณุฑูุนุฉ",
      },
      {
        name: "Neteller",
        price: "$20",
        category: "ูุญุงูุธ ุฅููุชุฑูููุฉ",
        icon: "๐ธ",
        active: true,
        sort: 4,
        description: "ูุฏููุนุงุช ููุฑูุฉ ุนุงูููุง",
      },
      {
        name: "Kast",
        price: "$20",
        category: "ูุญุงูุธ ุฅููุชุฑูููุฉ",
        icon: "๐ฏ",
        active: true,
        sort: 5,
        description: "ุญููู ุฏูุน ูุจุชูุฑุฉ",
      },
      {
        name: "Redotpay",
        price: "$20",
        category: "ูุญุงูุธ ุฅููุชุฑูููุฉ",
        icon: "๐ด",
        active: true,
        sort: 6,
        description: "ุจุทุงูุงุช ุงูุชุฑุงุถูุฉ ูุชูุฏูุฉ",
      },
      {
        name: "Okx",
        price: "$20",
        category: "ุนููุงุช ุฑูููุฉ",
        icon: "โก",
        active: true,
        sort: 7,
        description: "ููุตุฉ ุชุฏุงูู ุงูุนููุงุช ุงููุดูุฑุฉ",
      },
      {
        name: "World First",
        price: "$20",
        category: "ุญุณุงุจุงุช ุจูููุฉ",
        icon: "๐",
        active: true,
        sort: 8,
        description: "ุฎุฏูุงุช ูุตุฑููุฉ ุฏูููุฉ",
      },
      {
        name: "Bybit",
        price: "$20",
        category: "ุนููุงุช ุฑูููุฉ",
        icon: "๐",
        active: true,
        sort: 9,
        description: "ุชุฏุงูู ุงูุนููุฏ ุงูุขุฌูุฉ",
      },
      {
        name: "Bitget",
        price: "$20",
        category: "ุนููุงุช ุฑูููุฉ",
        icon: "๐",
        active: true,
        sort: 10,
        description: "ููุตุฉ ุชุฏุงูู ูุชุทูุฑุฉ",
      },
      {
        name: "Kucoin",
        price: "$20",
        category: "ุนููุงุช ุฑูููุฉ",
        icon: "๐ฅ",
        active: true,
        sort: 11,
        description: "ุจูุฑุตุฉ ุนููุงุช ุฑูููุฉ ุดุงููุฉ",
      },
      {
        name: "PayPal",
        price: "$15",
        category: "ูุญุงูุธ ุฅููุชุฑูููุฉ",
        icon: "๐",
        popular: true,
        active: true,
        sort: 12,
        description: "ุงูุญู ุงูุฃุดูุฑ ูููุฏููุนุงุช",
      },
      {
        name: "Mexc",
        price: "$20",
        category: "ุนููุงุช ุฑูููุฉ",
        icon: "๐",
        active: true,
        sort: 13,
        description: "ููุตุฉ ุชุฏุงูู ุนููุงุช ุฑูููุฉ",
      },
      {
        name: "Exness",
        price: "$20",
        category: "ุชุฏุงูู",
        icon: "๐",
        active: true,
        sort: 14,
        description: "ูุณูุท ููุฑูุณ ููุซูู",
      },
      {
        name: "ุดุญู ููุฏุงููู ูุงุด",
        price: "120 ุฌููู/100 ุฌููู",
        note: "ุฎุตู ูููููุงุช ุงููุจูุฑุฉ",
        category: "ุฎุฏูุงุช ูุญููุฉ",
        icon: "๐ฑ",
        active: true,
        sort: 15,
        description: "ุดุญู ููุฑู ุจุฃูุถู ุณุนุฑ",
      },
      {
        name: "ุณุญุจ ูู TikTok",
        price: "ุญุณุจ ุงููุจูุบ",
        category: "ุฎุฏูุงุช ุฎุงุตุฉ",
        icon: "๐ต",
        active: true,
        sort: 16,
        description: "ุณุญุจ ุฃุฑุจุงุญ ุชูู ุชูู ุจุณูููุฉ",
      },
      {
        name: "ุณุญุจ ูู PayPal",
        price: "ุญุณุจ ุงููุจูุบ",
        category: "ุฎุฏูุงุช ุฎุงุตุฉ",
        icon: "๐ฐ",
        active: true,
        sort: 17,
        description: "ุชุญููู ุฃููุงู PayPal ูุญููุง",
      },
    ],
    payments: [
      { label: "ููุฏุงููู ูุงุด", value: "01062453344", icon: "๐ฑ", color: "red" },
      { label: "USDT TRC20", value: "TFUt8GRpk2R8Wv3FvoCiSUghRBQo4HrmQK", icon: "โฟ", color: "green" },
    ],
    features: [
      { title: "ุฎุฏูุฉ ุณุฑูุนุฉ", desc: "ุชุณููู ุฎูุงู 24-48 ุณุงุนุฉ", icon: <Shield className="h-6 w-6" /> },
      { title: "ุฃูุงู ูุถููู", desc: "ุญูุงูุฉ ูุงููุฉ ูุจูุงูุงุชู", icon: <Shield className="h-6 w-6" /> },
      { title: "ุฏุนู ูุณุชูุฑ", desc: "ูุฑูู ุฏุนู ุนูู ูุฏุงุฑ ุงูุณุงุนุฉ", icon: <Shield className="h-6 w-6" /> },
      { title: "ุฃุณุนุงุฑ ุชูุงูุณูุฉ", desc: "ุฃูุถู ุงูุฃุณุนุงุฑ ูู ุงูุณูู", icon: <Shield className="h-6 w-6" /> },
    ],
    faq: [
      {
        question: "ูู ุชุณุชุบุฑู ุนูููุฉ ุฅูุดุงุก ุงูุญุณุงุจุ",
        answer:
          "ุนุงุฏุฉ ูู 24-48 ุณุงุนุฉ ุญุณุจ ููุน ุงูุญุณุงุจ ูุงููุชุทูุจุงุช. ูุญู ูุนูู ุจุฃูุตู ุณุฑุนุฉ ูุถูุงู ุญุตููู ุนูู ุญุณุงุจู ูู ุฃุณุฑุน ููุช ูููู.",
      },
      {
        question: "ูู ุงูุฎุฏูุฉ ุขููุฉ ููุถูููุฉุ",
        answer:
          "ูุนู ุชูุงูุงูุ ูุชุจุน ุฃุนูู ูุนุงููุฑ ุงูุฃูุงู ุงูุนุงูููุฉ ููุญุงูุธ ุนูู ุณุฑูุฉ ุจูุงูุงุชู ุงูุดุฎุตูุฉ. ููุง ููุฏู ุถูุงู ุงุณุชุฑุฏุงุฏ ุงููุงู ูู ุญุงูุฉ ุนุฏู ูุฌุงุญ ุงูุนูููุฉ.",
      },
      {
        question: "ูุง ูู ุทุฑู ุงูุฏูุน ุงููุชุงุญุฉุ",
        answer: "ููุจู ุงูุฏูุน ุนุจุฑ ููุฏุงููู ูุงุด ูุงูุนููุงุช ุงูุฑูููุฉ USDT TRC20 ููุท ูุถูุงู ุงูุฃูุงู ูุงูุณุฑุนุฉ ๏ฟฝ๏ฟฝู ุงููุนุงููุงุช.",
      },
      {
        question: "ูู ุชูุฏููู ุฎุฏูุฉ ูุง ุจุนุฏ ุงูุจูุนุ",
        answer: "ุจุงูุทุจุนุ ููุฏู ุฏุนู ููู ูุฌุงูู ูุฏู ุงูุญูุงุฉ ูุฌููุน ุนููุงุฆูุง ูุน ุฅุฑุดุงุฏุงุช ููุตูุฉ ูุงุณุช๏ฟฝ๏ฟฝุฏุงู ุญุณุงุจุงุชูู ุงูุฌุฏูุฏุฉ.",
      },
    ],
    contact: {
      title: "ุงุจุฏุฃ ูุนูุง ุงูููู",
      subtitle: "ูุฑูู ุงูุฏุนู ูุชุงุญ ุนูู ูุฏุงุฑ ุงูุณุงุนุฉ ููุฅุฌุงุจุฉ ุนูู ุงุณุชูุณุงุฑุงุชู",
      whatsapp: "ุชูุงุตู ุนุจุฑ ูุงุชุณุงุจ",
      features: ["ุฑุฏ ููุฑู", "ุงุณุชุดุงุฑุฉ ูุฌุงููุฉ", "ุถูุงู ุงูุฎุฏูุฉ"],
    },
  },
  en: {
    site: {
      name: "KYCtrust",
      description: "Specialized service for secure electronic banking accounts and financial services",
      phone: "+20-106-245-3344",
      tagline: "Your trusted partner in the digital world",
    },
    hero: {
      title: "KYCtrust",
      subtitle: "Complete Digital Financial Services Platform",
      description: "Get the best electronic banking accounts and digital wallets with unmatched security and speed",
      cta: "Start Your Financial Journey",
      secondary: "Browse Our Services",
      stats: [
        { number: "1000+", label: "Happy Clients" },
        { number: "24/7", label: "Support" },
        { number: "99.9%", label: "Success Rate" },
        { number: "15+", label: "Services" },
      ],
    },
    services: [
      {
        name: "Payoneer",
        price: "$30",
        category: "Banking",
        icon: "๐ณ",
        popular: true,
        active: true,
        sort: 1,
        description: "Trusted global banking account",
      },
      {
        name: "Wise",
        price: "$30",
        category: "Banking",
        icon: "๐ฆ",
        popular: true,
        active: true,
        sort: 2,
        description: "International transfers with lowest fees",
      },
      {
        name: "Skrill",
        price: "$20",
        category: "E-Wallets",
        icon: "๐ฐ",
        active: true,
        sort: 3,
        description: "Safe and fast digital wallet",
      },
      {
        name: "Neteller",
        price: "$20",
        category: "E-Wallets",
        icon: "๐ธ",
        active: true,
        sort: 4,
        description: "Instant payments worldwide",
      },
      {
        name: "Kast",
        price: "$20",
        category: "E-Wallets",
        icon: "๐ฏ",
        active: true,
        sort: 5,
        description: "Innovative payment solutions",
      },
      {
        name: "Redotpay",
        price: "$20",
        category: "E-Wallets",
        icon: "๐ด",
        active: true,
        sort: 6,
        description: "Advanced virtual cards",
      },
      {
        name: "Okx",
        price: "$20",
        category: "Crypto",
        icon: "โก",
        active: true,
        sort: 7,
        description: "Crypto trading platform",
      },
      {
        name: "World First",
        price: "$20",
        category: "Banking",
        icon: "๐",
        active: true,
        sort: 8,
        description: "International banking services",
      },
      {
        name: "Bybit",
        price: "$20",
        category: "Crypto",
        icon: "๐",
        active: true,
        sort: 9,
        description: "Futures trading platform",
      },
      {
        name: "Bitget",
        price: "$20",
        category: "Crypto",
        icon: "๐",
        active: true,
        sort: 10,
        description: "Advanced trading platform",
      },
      {
        name: "Kucoin",
        price: "$20",
        category: "Crypto",
        icon: "๐ฅ",
        active: true,
        sort: 11,
        description: "Comprehensive crypto exchange",
      },
      {
        name: "PayPal",
        price: "$15",
        category: "E-Wallets",
        icon: "๐",
        popular: true,
        active: true,
        sort: 12,
        description: "Most popular payment solution",
      },
      {
        name: "Mexc",
        price: "$20",
        category: "Crypto",
        icon: "๐",
        active: true,
        sort: 13,
        description: "Crypto trading exchange",
      },
      {
        name: "Exness",
        price: "$20",
        category: "Trading",
        icon: "๐",
        active: true,
        sort: 14,
        description: "Trusted forex broker",
      },
      {
        name: "Vodafone Cash Top-up",
        price: "120 EGP/100 EGP",
        note: "Bulk discount available",
        category: "Local Services",
        icon: "๐ฑ",
        active: true,
        sort: 15,
        description: "Instant top-up best rates",
      },
      {
        name: "TikTok Withdrawal",
        price: "Based on amount",
        category: "Special Services",
        icon: "๐ต",
        active: true,
        sort: 16,
        description: "Easy TikTok earnings withdrawal",
      },
      {
        name: "PayPal Withdrawal",
        price: "Based on amount",
        category: "Special Services",
        icon: "๐ฐ",
        active: true,
        sort: 17,
        description: "Local PayPal money transfer",
      },
    ],
    payments: [
      { label: "Vodafone Cash", value: "01062453344", icon: "๐ฑ", color: "red" },
      { label: "USDT TRC20", value: "TFUt8GRpk2R8Wv3FvoCiSUghRBQo4HrmQK", icon: "โฟ", color: "green" },
    ],
    features: [
      { title: "Fast Service", desc: "Delivery within 24-48 hours", icon: <Shield className="h-6 w-6" /> },
      { title: "Guaranteed Security", desc: "Complete protection for your data", icon: <Shield className="h-6 w-6" /> },
      { title: "Continuous Support", desc: "24/7 support team", icon: <Shield className="h-6 w-6" /> },
      { title: "Competitive Prices", desc: "Best prices in the market", icon: <Shield className="h-6 w-6" /> },
    ],
    faq: [
      {
        question: "How long does account creation take?",
        answer:
          "Usually 24-48 hours depending on account type and requirements. We work at maximum speed to ensure you get your account as soon as possible.",
      },
      {
        question: "Is the service safe and guaranteed?",
        answer:
          "Absolutely yes, we follow the highest international security standards and maintain confidentiality of your personal data. We also offer money-back guarantee if the process fails.",
      },
      {
        question: "What payment methods are available?",
        answer:
          "We accept payments via Vodafone Cash and USDT TRC20 cryptocurrency only to ensure security and speed in transactions.",
      },
      {
        question: "Do you provide after-sales service?",
        answer:
          "Of course, we provide free lifetime technical support for all our clients with detailed instructions for using your new accounts.",
      },
    ],
    contact: {
      title: "Get Started Today",
      subtitle: "Support team available 24/7 to answer your questions",
      whatsapp: "Contact via WhatsApp",
      features: ["Instant Reply", "Free Consultation", "Service Guarantee"],
    },
  },
}

// function buildWhatsApp(service: string, price: string, locale = "ar") {
//   const phone = "201062453344"
//   const timestamp = Date.now()
//   const requestId = `LP-${timestamp}`

//   const messages: Record<string, string> = {
//     ar: `๐ฅ ุทูุจ ุฎุฏูุฉ ูู KYCtrust

// ๐ ุชูุงุตูู ุงูุทูุจ:
// โข ุงูุฎุฏูุฉ: ${service}
// โข ุงูุณุนุฑ: ${price}
// โข ุงููุบุฉ: ${locale}
// โข ูุนุฑู ุงูุทูุจ: ${requestId}

// โฐ ุณูุฑุฏ ุนููู ุฎูุงู 15 ุฏูููุฉ
// ๐ก๏ธ ุฎุฏูุฉ ุขููุฉ ููุถูููุฉ 100%`,
//     en: `๐ฅ Service Request from KYCtrust

// ๐ Order Details:
// โข Service: ${service}
// โข Price: ${price}
// โข Language: ${locale}
// โข Request ID: ${requestId}

// โฐ We'll reply within 15 minutes
// ๐ก๏ธ 100% Safe and Guaranteed Service`,
//   }

//   const text = encodeURIComponent(messages[locale] || messages.ar)
//   return `https://wa.me/${phone}?text=${text}`
// }

// function useInViewAnimation() {
//   const [visibleMap, setVisibleMap] = React.useState<Record<string, boolean>>({})

//   useEffect(() => {
//     const observer = new IntersectionObserver(
//       (entries) => {
//         for (const entry of entries) {
//           const id = (entry.target as HTMLElement).dataset["animId"]
//           if (!id) continue
//           if (entry.isIntersecting) {
//             setVisibleMap((p) => ({ ...p, [id]: true }))
//             observer.unobserve(entry.target)
//           }
//         }
//       },
//       { threshold: 0.12 },
//     )

//     const nodes = document.querySelectorAll("[data-anim-id]")
//     nodes.forEach((n) => observer.observe(n))

//     return () => observer.disconnect()
//   }, [])

//   return (id: string, extra = "") =>
//     [
//       "transition-all duration-700 will-change-transform",
//       visibleMap[id] ? "opacity-100 translate-y-0" : "opacity-0 translate-y-6",
//       extra,
//     ].join(" ")
// }

// function CopyField({ value }: { value: string }) {
//   const [copied, setCopied] = React.useState(false)
//   const onCopy = async () => {
//     try {
//       await navigator.clipboard.writeText(value)
//       setCopied(true)
//       setTimeout(() => setCopied(false), 1500)
//     } catch {
//       // ignore
//     }
//   }
//   return (
//     <button
//       variant="ghost"
//       size="icon"
//       aria-label={copied ? "Copied" : "Copy"}
//       onClick={onCopy}
//       className="hover:scale-110"
//     >
//       {copied ? <Shield className="h-4 w-4 text-emerald-500" /> : <Shield className="h-4 w-4" />}
//     </button>
//   )
// }

export default function Page() {
  const { design, locale, setContent, setDesign } = useCMS()
  const { setTheme } = useTheme()

  // Sync theme and dir/lang
  useEffect(() => {
    if (design.theme !== "system") setTheme(design.theme)
    document.documentElement.setAttribute("dir", locale === "ar" ? "rtl" : "ltr")
    document.documentElement.setAttribute("lang", locale)
  }, [design.theme, locale, setTheme])

  // Load published content when available
  useEffect(() => {
    ;(async () => {
      try {
        const r = await fetch("/api/content/published", { cache: "no-store" })
        if (!r.ok) return
        const j = await r.json()
        if (j && j.ar && j.en) {
          setContent("ar", j.ar)
          setContent("en", j.en)
          if (j.design) setDesign(j.design)
        }
      } catch {}
    })()
  }, [setContent, setDesign])

  // Refetch on publish broadcast
  const refetchPublished = React.useCallback(async () => {
    try {
      const r = await fetch("/api/content/published", { cache: "no-store" })
      if (!r.ok) return
      const j = await r.json()
      if (j && j.ar && j.en) {
        setContent("ar", j.ar)
        setContent("en", j.en)
        if (j.design) setDesign(j.design)
      }
    } catch {}
  }, [setContent, setDesign])

  useEffect(() => {
    const unsub = subscribePublished(() => {
      refetchPublished()
    })
    return () => unsub()
  }, [refetchPublished])

  // Live preview from localStorage (while editing)
  useEffect(() => {
    const onStorage = (e: StorageEvent) => {
      if (e.key !== "kyctrust-cms" || !e.newValue) return
      try {
        const parsed = JSON.parse(e.newValue)
        const state = parsed.state || parsed
        if (state?.content) {
          if (state.content.ar) setContent("ar", state.content.ar)
          if (state.content.en) setContent("en", state.content.en)
        }
        if (state?.design) setDesign(state.design)
      } catch {}
    }
    window.addEventListener("storage", onStorage)
    return () => window.removeEventListener("storage", onStorage)
  }, [setContent, setDesign])

  return (
    <ThemeProvider attribute="class" defaultTheme="system" enableSystem>
      <div className="min-h-screen bg-gradient-to-b from-neutral-50 via-emerald-50/30 to-blue-50/20 text-neutral-900 dark:from-neutral-950 dark:via-neutral-950 dark:to-neutral-950 dark:text-neutral-100">
        <StructuredData />
        <PerfHints />
        <SiteHeader />
        <main id="main-content">
          <BlocksRenderer />
          <ReviewsSection />
        </main>
        <SiteFooter />
        <ChatbotWidget />
        <Toaster />
      </div>
    </ThemeProvider>
  )
}
